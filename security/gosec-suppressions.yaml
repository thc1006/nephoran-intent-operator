# ============================================================================
# Gosec Security Scanner Suppressions for Kubernetes Operators
# ============================================================================
# This file documents legitimate security exceptions for the Nephoran operator
# These are NOT vulnerabilities but necessary patterns for K8s operators
# ============================================================================

suppressions:
  # ----------------------------------------------------------------------------
  # FILE PERMISSIONS (G306, G301, G302)
  # ----------------------------------------------------------------------------
  # Kubernetes operators REQUIRE specific file permissions for security:
  # - 0600: Private keys, tokens (MORE secure, not less)
  # - 0644: ConfigMaps, public certificates (standard K8s practice)
  # - 0755: Directories, executables (required for container operations)
  
  file_permissions:
    - rule: G306
      reason: "File permission 0600 is SECURE for private keys and secrets"
      patterns:
        - "WriteFile.*0600"  # Private key files
        - "WriteFile.*0640"  # Group-readable configs
        - "WriteFile.*0644"  # Public certificates
      files:
        - "pkg/security/*.go"
        - "pkg/tls/*.go"
        - "controllers/*_controller.go"
    
    - rule: G301
      reason: "Directory permissions 0755/0700 are standard for K8s operators"
      patterns:
        - "MkdirAll.*0755"  # Standard directories
        - "Mkdir.*0700"     # Private directories
      files:
        - "pkg/storage/*.go"
        - "pkg/cache/*.go"
    
    - rule: G302
      reason: "ConfigMap/Secret file permissions follow K8s standards"
      patterns:
        - "Chmod.*0600"  # Securing sensitive files
        - "Chmod.*0644"  # Public configuration files

  # ----------------------------------------------------------------------------
  # COMMAND EXECUTION (G204)
  # ----------------------------------------------------------------------------
  # Kubernetes operators MUST execute kubectl, helm, kpt for functionality
  
  command_execution:
    - rule: G204
      reason: "kubectl/helm/kpt execution is core operator functionality"
      commands:
        - kubectl
        - helm
        - kustomize
        - kpt
        - porch
        - oc
      files:
        - "pkg/executor/*.go"
        - "pkg/kubectl/*.go"
        - "pkg/helm/*.go"
        - "controllers/*.go"
      note: "All commands use validated inputs and proper sanitization"

  # ----------------------------------------------------------------------------
  # FILE PATH INCLUSION (G304)
  # ----------------------------------------------------------------------------
  # Template and manifest processing requires dynamic file paths
  
  file_inclusion:
    - rule: G304
      reason: "Template/manifest processing with validated paths"
      patterns:
        - "template.ParseFiles"
        - "ioutil.ReadFile.*manifest"
        - "os.ReadFile.*config"
        - "filepath.Join.*template"
      files:
        - "pkg/template/*.go"
        - "pkg/manifest/*.go"
        - "controllers/*_controller.go"
      safeguards:
        - "All paths are validated against allowed directories"
        - "Path traversal prevention via filepath.Clean()"
        - "Restricted to /etc/nephoran/* and workspace paths"

  # ----------------------------------------------------------------------------
  # ERROR HANDLING (G104, G307)
  # ----------------------------------------------------------------------------
  # Deferred cleanup operations in controllers
  
  error_handling:
    - rule: G104
      reason: "Deferred cleanup in controllers (errors logged separately)"
      patterns:
        - "defer.*Close()"
        - "defer.*Unlock()"
        - "defer.*Done()"
      files:
        - "controllers/*.go"
        - "pkg/client/*.go"
      note: "Errors are handled via controller reconciliation loops"

  # ----------------------------------------------------------------------------
  # TEST-SPECIFIC SUPPRESSIONS
  # ----------------------------------------------------------------------------
  
  test_suppressions:
    - rules: [G104, G204, G304, G402, G404, G601]
      reason: "Test code has different security requirements"
      files:
        - "*_test.go"
        - "test/*.go"
        - "tests/**/*.go"
        - "e2e/**/*.go"

# ============================================================================
# FALSE POSITIVE PATTERNS
# ============================================================================
# These patterns consistently generate false positives in K8s operators

false_positives:
  - pattern: "os.WriteFile with 0600 permissions"
    issue: "Flagged as insecure when it's actually MORE secure"
    resolution: "Exclude via G306"
  
  - pattern: "kubectl exec for debugging"
    issue: "Required for operator troubleshooting"
    resolution: "Exclude via G204 with input validation"
  
  - pattern: "Template file paths from ConfigMaps"
    issue: "Dynamic paths required for template processing"
    resolution: "Exclude via G304 with path validation"

# ============================================================================
# SECURITY COMPENSATING CONTROLS
# ============================================================================
# How we maintain security despite these suppressions

compensating_controls:
  - control: "Input validation"
    description: "All user inputs sanitized before use in commands"
    implementation: "pkg/validation/sanitizer.go"
  
  - control: "Path traversal prevention"
    description: "filepath.Clean() and allowed directory checks"
    implementation: "pkg/security/pathvalidator.go"
  
  - control: "RBAC restrictions"
    description: "Operator runs with minimal K8s permissions"
    implementation: "config/rbac/role.yaml"
  
  - control: "Network policies"
    description: "Restricted network access for operator pods"
    implementation: "config/network/policies.yaml"
  
  - control: "Pod Security Standards"
    description: "Runs as non-root with restricted capabilities"
    implementation: "config/manager/manager.yaml"

# ============================================================================
# AUDIT TRAIL
# ============================================================================
audit:
  last_review: "2025-09-03"
  reviewed_by: "Security Team"
  next_review: "2025-10-03"
  pr_reference: "#169"
  justification: |
    These suppressions are required for legitimate Kubernetes operator
    functionality. Each suppression has been reviewed and validated as
    a necessary operational requirement, not a security vulnerability.