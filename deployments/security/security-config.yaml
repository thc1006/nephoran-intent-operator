apiVersion: v1
kind: ConfigMap
metadata:
  name: security-config
  namespace: nephoran-system
  labels:
    app.kubernetes.io/name: nephoran-intent-operator
    app.kubernetes.io/component: security
data:
  # Authentication Configuration
  auth_enabled: "true"
  oauth2_enabled: "true"
  mfa_enabled: "true"
  mfa_required_for_admin: "true"
  mfa_required_for_operator: "false"
  
  # OAuth2 Providers Configuration
  oauth2_providers: |
    azure:
      enabled: true
      client_id: "${AZURE_CLIENT_ID}"
      tenant_id: "${AZURE_TENANT_ID}"
      redirect_uri: "https://nephoran.company.com/auth/azure/callback"
    okta:
      enabled: true
      domain: "${OKTA_DOMAIN}"
      client_id: "${OKTA_CLIENT_ID}"
      redirect_uri: "https://nephoran.company.com/auth/okta/callback"
    keycloak:
      enabled: false
      base_url: "${KEYCLOAK_BASE_URL}"
      realm: "${KEYCLOAK_REALM}"
      client_id: "${KEYCLOAK_CLIENT_ID}"
    google:
      enabled: false
      client_id: "${GOOGLE_CLIENT_ID}"
      redirect_uri: "https://nephoran.company.com/auth/google/callback"

  # MFA Configuration
  mfa_config: |
    totp_enabled: true
    email_enabled: true
    sms_enabled: false
    backup_codes_enabled: true
    code_length: 6
    code_ttl: "5m"
    max_attempts: 3
    attempt_window: "15m"
    issuer_name: "Nephoran Intent Operator"

  # Token Blacklist Configuration
  token_blacklist: |
    redis_addr: "redis:6379"
    redis_db: 1
    redis_key_prefix: "nephoran:blacklist:"
    local_cache_size: 10000
    local_cache_ttl: "5m"
    cleanup_interval: "1h"
    max_token_age: "168h"
    enable_compression: true

  # Security Scanner Configuration
  security_scanner: |
    enabled: true
    scan_interval: "24h"
    enable_vuln_scanning: true
    enable_port_scanning: false
    enable_owasp_testing: true
    enable_auth_testing: true
    enable_injection_testing: true
    max_concurrency: 10
    timeout: "30s"

  # Vulnerability Manager Configuration
  vulnerability_manager: |
    enable_cve_scanning: true
    enable_dependency_check: true
    enable_image_scanning: true
    enable_code_scanning: true
    scan_interval: "24h"
    auto_remediation: false
    max_cvss_for_auto: 6.0
    alert_thresholds:
      critical_threshold: 1
      high_threshold: 5
      cvss_threshold: 7.0
      time_to_remediate: "48h"

  # Incident Response Configuration
  incident_response: |
    enable_auto_response: true
    auto_response_threshold: "High"
    max_auto_actions: 10
    incident_retention: "2160h"
    escalation_timeout: "30m"
    forensics_enabled: true

  # Rate Limiting Configuration
  rate_limiting: |
    enabled: true
    requests_per_minute: 60
    burst_capacity: 100
    cleanup_interval: "10m"
    block_duration: "15m"

  # TLS Configuration
  tls_config: |
    min_version: "1.3"
    cipher_suites:
      - "TLS_AES_256_GCM_SHA384"
      - "TLS_CHACHA20_POLY1305_SHA256"
      - "TLS_AES_128_GCM_SHA256"
    cert_rotation_interval: "2160h"
    enable_mtls: true

---
apiVersion: v1
kind: Secret
metadata:
  name: security-secrets
  namespace: nephoran-system
  labels:
    app.kubernetes.io/name: nephoran-intent-operator
    app.kubernetes.io/component: security
type: Opaque
stringData:
  # OAuth2 Provider Secrets
  azure_client_secret: "${AZURE_CLIENT_SECRET}"
  okta_client_secret: "${OKTA_CLIENT_SECRET}"
  keycloak_client_secret: "${KEYCLOAK_CLIENT_SECRET}"
  google_client_secret: "${GOOGLE_CLIENT_SECRET}"
  
  # JWT Signing Keys
  jwt_signing_key: "${JWT_SIGNING_KEY}"
  jwt_encryption_key: "${JWT_ENCRYPTION_KEY}"
  
  # Redis Configuration
  redis_password: "${REDIS_PASSWORD}"
  
  # Email MFA Configuration
  smtp_username: "${SMTP_USERNAME}"
  smtp_password: "${SMTP_PASSWORD}"
  
  # SMS MFA Configuration (Twilio example)
  twilio_account_sid: "${TWILIO_ACCOUNT_SID}"
  twilio_auth_token: "${TWILIO_AUTH_TOKEN}"
  
  # External Security Services
  vulnerability_db_api_key: "${NVD_API_KEY}"
  slack_webhook_url: "${SLACK_WEBHOOK_URL}"
  jira_api_token: "${JIRA_API_TOKEN}"
  
  # Backup Encryption Keys
  backup_encryption_key: "${BACKUP_ENCRYPTION_KEY}"
  
  # Certificate Authority
  ca_private_key: |
    -----BEGIN PRIVATE KEY-----
    ${CA_PRIVATE_KEY}
    -----END PRIVATE KEY-----
  ca_certificate: |
    -----BEGIN CERTIFICATE-----
    ${CA_CERTIFICATE}
    -----END CERTIFICATE-----

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: notification-config
  namespace: nephoran-system
  labels:
    app.kubernetes.io/name: nephoran-intent-operator
    app.kubernetes.io/component: security
data:
  # Email Configuration
  email_config: |
    smtp_host: "smtp.company.com"
    smtp_port: 587
    from_address: "security@company.com"
    from_name: "Nephoran Security Team"
    subject: "Nephoran Security Alert"
    template: |
      Security Alert: {{.title}}
      
      Severity: {{.severity}}
      Description: {{.description}}
      
      Time: {{.timestamp}}
      System: {{.system}}
      
      Please review and take appropriate action.
      
      Nephoran Security Team

  # Slack Configuration
  slack_config: |
    channel: "#security-alerts"
    username: "Nephoran Security Bot"
    template: |
      {
        "text": "ðŸš¨ Security Alert: {{.title}}",
        "attachments": [
          {
            "color": "{{if eq .severity \"Critical\"}}danger{{else if eq .severity \"High\"}}warning{{else}}good{{end}}",
            "fields": [
              {
                "title": "Severity",
                "value": "{{.severity}}",
                "short": true
              },
              {
                "title": "System",
                "value": "{{.system}}",
                "short": true
              },
              {
                "title": "Description",
                "value": "{{.description}}",
                "short": false
              }
            ],
            "footer": "Nephoran Intent Operator",
            "ts": {{.unix_timestamp}}
          }
        ]
      }

  # Jira Configuration
  jira_config: |
    url: "https://company.atlassian.net"
    project_key: "SEC"
    issue_type: "Security Issue"
    template: |
      h1. Security Issue Report
      
      *Severity:* {{.severity}}
      *System:* {{.system}}
      *Detection Time:* {{.timestamp}}
      
      h2. Description
      {{.description}}
      
      h2. Evidence
      {{.evidence}}
      
      h2. Recommended Actions
      {{.recommendations}}
      
      This issue was automatically created by the Nephoran Intent Operator security system.

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: security-policies
  namespace: nephoran-system
  labels:
    app.kubernetes.io/name: nephoran-intent-operator
    app.kubernetes.io/component: security
data:
  # Password Policy
  password_policy: |
    min_length: 12
    require_uppercase: true
    require_lowercase: true
    require_numbers: true
    require_special_chars: true
    max_age: "2160h"  # 90 days
    history_count: 12
    lockout_attempts: 5
    lockout_duration: "30m"

  # Session Policy
  session_policy: |
    max_duration: "8h"
    idle_timeout: "30m"
    concurrent_sessions: 3
    secure_cookies: true
    same_site: "strict"
    rotate_on_auth: true

  # API Security Policy
  api_security_policy: |
    require_authentication: true
    require_authorization: true
    rate_limiting:
      enabled: true
      requests_per_minute: 100
      burst_capacity: 200
    input_validation:
      enabled: true
      max_request_size: "10MB"
      allowed_content_types:
        - "application/json"
        - "application/x-www-form-urlencoded"
        - "multipart/form-data"
    cors_policy:
      allowed_origins:
        - "https://nephoran.company.com"
        - "https://admin.nephoran.company.com"
      allowed_methods:
        - "GET"
        - "POST"
        - "PUT"
        - "DELETE"
        - "PATCH"
      allowed_headers:
        - "Authorization"
        - "Content-Type"
        - "X-Request-ID"
      max_age: "3600"

  # Network Security Policy
  network_security_policy: |
    default_deny: true
    allow_rules:
      - name: "llm-processor-to-rag-api" 
        source: "llm-processor"
        destination: "rag-api"
        ports: [8080]
        protocol: "TCP"
      - name: "controllers-to-llm-processor"
        source: "nephio-bridge"
        destination: "llm-processor"
        ports: [8080]
        protocol: "TCP"
      - name: "rag-api-to-weaviate"
        source: "rag-api"
        destination: "weaviate"
        ports: [8080]
        protocol: "TCP"
      - name: "external-https"
        source: "*"
        destination: "*"
        ports: [443]
        protocol: "TCP"
        direction: "egress"
    blocked_ports:
      - 22    # SSH
      - 23    # Telnet
      - 135   # RPC
      - 445   # SMB