---
# Pod Security Standards for Nephoran Intent Operator
# Implements restricted security contexts following O-RAN WG11 specifications
# Enforces defense-in-depth at the container level

################################################################################
# Pod Security Policy (for clusters with PSP enabled)
################################################################################

---
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: nephoran-restricted
  labels:
    app.kubernetes.io/name: nephoran-intent-operator
    security.nephoran.io/level: restricted
  annotations:
    seccomp.security.alpha.kubernetes.io/allowedProfileNames: 'runtime/default,docker/default'
    apparmor.security.beta.kubernetes.io/allowedProfileNames: 'runtime/default'
    seccomp.security.alpha.kubernetes.io/defaultProfileName: 'runtime/default'
    apparmor.security.beta.kubernetes.io/defaultProfileName: 'runtime/default'
spec:
  # Privilege Escalation
  privileged: false
  allowPrivilegeEscalation: false
  
  # User and Group Settings
  runAsUser:
    rule: MustRunAsNonRoot
    ranges:
    - min: 1000
      max: 65535
  runAsGroup:
    rule: MustRunAs
    ranges:
    - min: 1000
      max: 65535
  fsGroup:
    rule: MustRunAs
    ranges:
    - min: 1000
      max: 65535
  supplementalGroups:
    rule: MustRunAs
    ranges:
    - min: 1000
      max: 65535
  
  # Capabilities
  requiredDropCapabilities:
  - ALL
  allowedCapabilities: []
  defaultAddCapabilities: []
  
  # Volume Types
  volumes:
  - configMap
  - downwardAPI
  - emptyDir
  - persistentVolumeClaim
  - projected
  - secret
  
  # Host Features (all disabled)
  hostNetwork: false
  hostPID: false
  hostIPC: false
  hostPorts: []
  
  # SELinux
  seLinux:
    rule: RunAsAny
  
  # Read-only root filesystem
  readOnlyRootFilesystem: true
  
  # Seccomp
  annotations:
    seccomp.security.alpha.kubernetes.io/allowedProfileNames: 'runtime/default'
    seccomp.security.alpha.kubernetes.io/defaultProfileName: 'runtime/default'

---
# Less restrictive PSP for Weaviate (requires some additional permissions)
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: nephoran-weaviate
  labels:
    app.kubernetes.io/name: nephoran-intent-operator
    app.kubernetes.io/component: weaviate
    security.nephoran.io/level: baseline
spec:
  privileged: false
  allowPrivilegeEscalation: false
  
  runAsUser:
    rule: RunAsAny
  runAsGroup:
    rule: RunAsAny
  fsGroup:
    rule: RunAsAny
  supplementalGroups:
    rule: RunAsAny
  
  requiredDropCapabilities:
  - KILL
  - MKNOD
  - SETUID
  - SETGID
  allowedCapabilities:
  - CHOWN
  - DAC_OVERRIDE
  - FOWNER
  - SETPCAP
  
  volumes:
  - configMap
  - downwardAPI
  - emptyDir
  - persistentVolumeClaim
  - projected
  - secret
  - hostPath # Required for persistent storage
  
  allowedHostPaths:
  - pathPrefix: "/var/lib/weaviate"
    readOnly: false
  
  hostNetwork: false
  hostPID: false
  hostIPC: false
  
  seLinux:
    rule: RunAsAny
  
  readOnlyRootFilesystem: false # Weaviate needs write access

################################################################################
# Pod Security Standards (Kubernetes 1.23+)
################################################################################

---
# Enforce restricted security standard for nephoran-system namespace
apiVersion: v1
kind: Namespace
metadata:
  name: nephoran-system
  labels:
    pod-security.kubernetes.io/enforce: restricted
    pod-security.kubernetes.io/enforce-version: latest
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/audit-version: latest
    pod-security.kubernetes.io/warn: restricted
    pod-security.kubernetes.io/warn-version: latest
    app.kubernetes.io/name: nephoran-intent-operator

################################################################################
# Security Context Templates (to be included in deployments)
################################################################################

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: security-context-templates
  namespace: nephoran-system
  labels:
    app.kubernetes.io/name: nephoran-intent-operator
    security.nephoran.io/type: templates
data:
  # Standard restricted security context for most components
  restricted-security-context.yaml: |
    securityContext:
      runAsNonRoot: true
      runAsUser: 65534  # nobody user
      runAsGroup: 65534
      fsGroup: 65534
      fsGroupChangePolicy: "OnRootMismatch"
      seccompProfile:
        type: RuntimeDefault
      capabilities:
        drop:
        - ALL
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      privileged: false
  
  # Container-level security context
  container-security-context.yaml: |
    securityContext:
      runAsNonRoot: true
      runAsUser: 65534
      runAsGroup: 65534
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop:
        - ALL
      seccompProfile:
        type: RuntimeDefault
  
  # Weaviate security context (less restrictive)
  weaviate-security-context.yaml: |
    securityContext:
      runAsNonRoot: true
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000
      fsGroupChangePolicy: "Always"
      seccompProfile:
        type: RuntimeDefault
      capabilities:
        drop:
        - ALL
        add:
        - CHOWN
        - DAC_OVERRIDE
        - FOWNER
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: false
      privileged: false

################################################################################
# Security Contexts for Each Component
################################################################################

---
# Nephoran Operator Security Context
apiVersion: v1
kind: ConfigMap
metadata:
  name: nephoran-operator-security
  namespace: nephoran-system
  labels:
    app.kubernetes.io/name: nephoran-intent-operator
    app.kubernetes.io/component: controller-manager
data:
  pod-security.yaml: |
    apiVersion: v1
    kind: Pod
    spec:
      serviceAccountName: nephoran-operator
      automountServiceAccountToken: true
      securityContext:
        runAsNonRoot: true
        runAsUser: 65532
        runAsGroup: 65532
        fsGroup: 65532
        fsGroupChangePolicy: "OnRootMismatch"
        seccompProfile:
          type: RuntimeDefault
        supplementalGroups: []
        sysctls: []
      containers:
      - name: manager
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 65532
          runAsGroup: 65532
        volumeMounts:
        - name: tmp
          mountPath: /tmp
          readOnly: false
        - name: cache
          mountPath: /cache
          readOnly: false
      volumes:
      - name: tmp
        emptyDir:
          sizeLimit: 100Mi
      - name: cache
        emptyDir:
          sizeLimit: 500Mi

---
# LLM Processor Security Context
apiVersion: v1
kind: ConfigMap
metadata:
  name: llm-processor-security
  namespace: nephoran-system
  labels:
    app.kubernetes.io/name: nephoran-intent-operator
    app.kubernetes.io/component: llm-processor
data:
  pod-security.yaml: |
    apiVersion: v1
    kind: Pod
    spec:
      serviceAccountName: llm-processor
      automountServiceAccountToken: true
      securityContext:
        runAsNonRoot: true
        runAsUser: 10001
        runAsGroup: 10001
        fsGroup: 10001
        fsGroupChangePolicy: "OnRootMismatch"
        seccompProfile:
          type: RuntimeDefault
      containers:
      - name: llm-processor
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
          runAsNonRoot: true
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: cache
          mountPath: /app/cache
      volumes:
      - name: tmp
        emptyDir:
          sizeLimit: 200Mi
      - name: cache
        emptyDir:
          sizeLimit: 1Gi

---
# RAG API Security Context
apiVersion: v1
kind: ConfigMap
metadata:
  name: rag-api-security
  namespace: nephoran-system
  labels:
    app.kubernetes.io/name: nephoran-intent-operator
    app.kubernetes.io/component: rag-api
data:
  pod-security.yaml: |
    apiVersion: v1
    kind: Pod
    spec:
      serviceAccountName: rag-api
      automountServiceAccountToken: true
      securityContext:
        runAsNonRoot: true
        runAsUser: 10002
        runAsGroup: 10002
        fsGroup: 10002
        fsGroupChangePolicy: "OnRootMismatch"
        seccompProfile:
          type: RuntimeDefault
      containers:
      - name: rag-api
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
          runAsNonRoot: true
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: cache
          mountPath: /app/cache
        - name: knowledge-base
          mountPath: /app/knowledge
          readOnly: true
      volumes:
      - name: tmp
        emptyDir:
          sizeLimit: 200Mi
      - name: cache
        emptyDir:
          sizeLimit: 2Gi
      - name: knowledge-base
        persistentVolumeClaim:
          claimName: knowledge-base-pvc
          readOnly: true

---
# Nephio Bridge Security Context
apiVersion: v1
kind: ConfigMap
metadata:
  name: nephio-bridge-security
  namespace: nephoran-system
  labels:
    app.kubernetes.io/name: nephoran-intent-operator
    app.kubernetes.io/component: nephio-bridge
data:
  pod-security.yaml: |
    apiVersion: v1
    kind: Pod
    spec:
      serviceAccountName: nephio-bridge
      automountServiceAccountToken: true
      securityContext:
        runAsNonRoot: true
        runAsUser: 10003
        runAsGroup: 10003
        fsGroup: 10003
        fsGroupChangePolicy: "OnRootMismatch"
        seccompProfile:
          type: RuntimeDefault
      containers:
      - name: nephio-bridge
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
          runAsNonRoot: true
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: git-cache
          mountPath: /app/git-cache
      volumes:
      - name: tmp
        emptyDir:
          sizeLimit: 100Mi
      - name: git-cache
        emptyDir:
          sizeLimit: 500Mi

---
# O-RAN Adaptor Security Context
apiVersion: v1
kind: ConfigMap
metadata:
  name: oran-adaptor-security
  namespace: nephoran-system
  labels:
    app.kubernetes.io/name: nephoran-intent-operator
    app.kubernetes.io/component: oran-adaptor
data:
  pod-security.yaml: |
    apiVersion: v1
    kind: Pod
    spec:
      serviceAccountName: oran-adaptor
      automountServiceAccountToken: true
      securityContext:
        runAsNonRoot: true
        runAsUser: 10004
        runAsGroup: 10004
        fsGroup: 10004
        fsGroupChangePolicy: "OnRootMismatch"
        seccompProfile:
          type: RuntimeDefault
      containers:
      - name: oran-adaptor
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
            add:
            - NET_RAW  # Required for SCTP (E2 interface)
          readOnlyRootFilesystem: true
          runAsNonRoot: true
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: yang-models
          mountPath: /app/yang
          readOnly: true
      volumes:
      - name: tmp
        emptyDir:
          sizeLimit: 100Mi
      - name: yang-models
        configMap:
          name: yang-models

################################################################################
# AppArmor Profiles
################################################################################

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: apparmor-profiles
  namespace: nephoran-system
  labels:
    app.kubernetes.io/name: nephoran-intent-operator
    security.nephoran.io/type: apparmor
data:
  nephoran-default: |
    #include <tunables/global>
    
    profile nephoran-default flags=(attach_disconnected,mediate_deleted) {
      #include <abstractions/base>
      
      # Allow network access
      network inet tcp,
      network inet udp,
      network inet icmp,
      network inet6 tcp,
      network inet6 udp,
      network inet6 icmp,
      
      # File access
      /usr/bin/* r,
      /usr/lib/* r,
      /lib/* r,
      /app/** r,
      /tmp/** rw,
      /cache/** rw,
      
      # Deny everything else
      deny /** w,
      deny @{HOME}/** w,
      deny /root/** rwx,
      deny /etc/shadow r,
      deny /etc/gshadow r,
      
      # Process capabilities
      capability net_bind_service,
      capability setuid,
      capability setgid,
      deny capability dac_override,
      deny capability sys_admin,
      deny capability sys_module,
      deny capability sys_ptrace,
    }

################################################################################
# Seccomp Profiles
################################################################################

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: seccomp-profiles
  namespace: nephoran-system
  labels:
    app.kubernetes.io/name: nephoran-intent-operator
    security.nephoran.io/type: seccomp
data:
  nephoran-default.json: |
    {
      "defaultAction": "SCMP_ACT_ERRNO",
      "architectures": [
        "SCMP_ARCH_X86_64",
        "SCMP_ARCH_X86",
        "SCMP_ARCH_X32",
        "SCMP_ARCH_AARCH64",
        "SCMP_ARCH_ARM"
      ],
      "syscalls": [
        {
          "names": [
            "accept",
            "accept4",
            "access",
            "arch_prctl",
            "bind",
            "brk",
            "capget",
            "capset",
            "chdir",
            "chmod",
            "chown",
            "clock_getres",
            "clock_gettime",
            "clock_nanosleep",
            "clone",
            "close",
            "connect",
            "dup",
            "dup2",
            "dup3",
            "epoll_create",
            "epoll_create1",
            "epoll_ctl",
            "epoll_ctl_old",
            "epoll_pwait",
            "epoll_wait",
            "epoll_wait_old",
            "eventfd",
            "eventfd2",
            "execve",
            "execveat",
            "exit",
            "exit_group",
            "faccessat",
            "fadvise64",
            "fallocate",
            "fchdir",
            "fchmod",
            "fchmodat",
            "fchown",
            "fchownat",
            "fcntl",
            "fdatasync",
            "fgetxattr",
            "flistxattr",
            "flock",
            "fork",
            "fremovexattr",
            "fsetxattr",
            "fstat",
            "fstatfs",
            "fsync",
            "ftruncate",
            "futex",
            "getcwd",
            "getdents",
            "getdents64",
            "getegid",
            "geteuid",
            "getgid",
            "getgroups",
            "getitimer",
            "getpeername",
            "getpgid",
            "getpgrp",
            "getpid",
            "getppid",
            "getpriority",
            "getrandom",
            "getresgid",
            "getresuid",
            "getrlimit",
            "getrusage",
            "getsid",
            "getsockname",
            "getsockopt",
            "gettid",
            "gettimeofday",
            "getuid",
            "getxattr",
            "inotify_add_watch",
            "inotify_init",
            "inotify_init1",
            "inotify_rm_watch",
            "io_cancel",
            "io_destroy",
            "io_getevents",
            "io_setup",
            "io_submit",
            "ioctl",
            "ioprio_get",
            "ioprio_set",
            "kill",
            "lgetxattr",
            "link",
            "linkat",
            "listen",
            "listxattr",
            "llistxattr",
            "lremovexattr",
            "lseek",
            "lsetxattr",
            "lstat",
            "madvise",
            "memfd_create",
            "mincore",
            "mkdir",
            "mkdirat",
            "mknod",
            "mknodat",
            "mlock",
            "mlock2",
            "mlockall",
            "mmap",
            "mprotect",
            "mremap",
            "msgctl",
            "msgget",
            "msgrcv",
            "msgsnd",
            "msync",
            "munlock",
            "munlockall",
            "munmap",
            "nanosleep",
            "newfstatat",
            "open",
            "openat",
            "pause",
            "pipe",
            "pipe2",
            "poll",
            "ppoll",
            "prctl",
            "pread64",
            "preadv",
            "preadv2",
            "prlimit64",
            "pselect6",
            "pwrite64",
            "pwritev",
            "pwritev2",
            "read",
            "readahead",
            "readlink",
            "readlinkat",
            "readv",
            "recvfrom",
            "recvmmsg",
            "recvmsg",
            "remap_file_pages",
            "removexattr",
            "rename",
            "renameat",
            "renameat2",
            "restart_syscall",
            "rmdir",
            "rt_sigaction",
            "rt_sigpending",
            "rt_sigprocmask",
            "rt_sigqueueinfo",
            "rt_sigreturn",
            "rt_sigsuspend",
            "rt_sigtimedwait",
            "rt_tgsigqueueinfo",
            "sched_getaffinity",
            "sched_getattr",
            "sched_getparam",
            "sched_get_priority_max",
            "sched_get_priority_min",
            "sched_getscheduler",
            "sched_rr_get_interval",
            "sched_setaffinity",
            "sched_setattr",
            "sched_setparam",
            "sched_setscheduler",
            "sched_yield",
            "seccomp",
            "select",
            "semctl",
            "semget",
            "semop",
            "semtimedop",
            "sendfile",
            "sendmmsg",
            "sendmsg",
            "sendto",
            "setfsgid",
            "setfsuid",
            "setgid",
            "setgroups",
            "setitimer",
            "setpgid",
            "setpriority",
            "setregid",
            "setresgid",
            "setresuid",
            "setreuid",
            "setrlimit",
            "setsid",
            "setsockopt",
            "setuid",
            "setxattr",
            "shmat",
            "shmctl",
            "shmdt",
            "shmget",
            "shutdown",
            "sigaltstack",
            "signalfd",
            "signalfd4",
            "socket",
            "socketpair",
            "splice",
            "stat",
            "statfs",
            "statx",
            "symlink",
            "symlinkat",
            "sync",
            "sync_file_range",
            "syncfs",
            "sysinfo",
            "tee",
            "tgkill",
            "time",
            "timer_create",
            "timer_delete",
            "timer_getoverrun",
            "timer_gettime",
            "timer_settime",
            "timerfd_create",
            "timerfd_gettime",
            "timerfd_settime",
            "times",
            "tkill",
            "truncate",
            "umask",
            "uname",
            "unlink",
            "unlinkat",
            "utime",
            "utimensat",
            "utimes",
            "vfork",
            "vmsplice",
            "wait4",
            "waitid",
            "write",
            "writev"
          ],
          "action": "SCMP_ACT_ALLOW"
        }
      ]
    }

################################################################################
# Resource Quotas and Limits
################################################################################

---
apiVersion: v1
kind: ResourceQuota
metadata:
  name: nephoran-resource-quota
  namespace: nephoran-system
  labels:
    app.kubernetes.io/name: nephoran-intent-operator
spec:
  hard:
    requests.cpu: "100"
    requests.memory: "200Gi"
    requests.storage: "1Ti"
    persistentvolumeclaims: "20"
    pods: "100"
    services: "20"
    services.loadbalancers: "2"
    services.nodeports: "0"  # Disable NodePort services for security

---
apiVersion: v1
kind: LimitRange
metadata:
  name: nephoran-limit-range
  namespace: nephoran-system
  labels:
    app.kubernetes.io/name: nephoran-intent-operator
spec:
  limits:
  - max:
      cpu: "8"
      memory: "16Gi"
    min:
      cpu: "100m"
      memory: "128Mi"
    default:
      cpu: "1"
      memory: "1Gi"
    defaultRequest:
      cpu: "100m"
      memory: "128Mi"
    type: Container
  - max:
      storage: "100Gi"
    min:
      storage: "1Gi"
    type: PersistentVolumeClaim