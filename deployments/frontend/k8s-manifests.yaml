---
# Namespace for Intent System
apiVersion: v1
kind: Namespace
metadata:
  name: nephoran-intent
  labels:
    app.kubernetes.io/name: nephoran-intent
    app.kubernetes.io/component: orchestration

---
# ConfigMap for Frontend HTML
apiVersion: v1
kind: ConfigMap
metadata:
  name: nephoran-frontend-config
  namespace: nephoran-intent
  labels:
    app.kubernetes.io/name: nephoran-frontend
    app.kubernetes.io/component: ui
data:
  index.html: |
    <!-- Frontend HTML content will be automatically populated from index.html -->

---
# Nginx ConfigMap for serving frontend
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: nephoran-intent
  labels:
    app.kubernetes.io/name: nephoran-frontend
    app.kubernetes.io/component: ui
data:
  nginx.conf: |
    events {
        worker_connections 1024;
    }

    http {
        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" "$http_x_forwarded_for"';

        access_log /var/log/nginx/access.log main;
        error_log /var/log/nginx/error.log warn;

        sendfile on;
        keepalive_timeout 65;
        gzip on;

        server {
            listen 80;
            server_name _;

            root /usr/share/nginx/html;
            index index.html;

            location / {
                try_files $uri $uri/ /index.html;
                add_header Cache-Control "no-cache, no-store, must-revalidate";
                add_header Pragma "no-cache";
                add_header Expires "0";
            }

            location /healthz {
                access_log off;
                return 200 "healthy\n";
                add_header Content-Type text/plain;
            }
        }
    }

---
# Frontend Deployment (Nginx serving the HTML)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nephoran-frontend
  namespace: nephoran-intent
  labels:
    app.kubernetes.io/name: nephoran-frontend
    app.kubernetes.io/component: ui
    app.kubernetes.io/version: "1.0.0"
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nephoran-frontend
  template:
    metadata:
      labels:
        app: nephoran-frontend
        app.kubernetes.io/name: nephoran-frontend
        app.kubernetes.io/component: ui
    spec:
      containers:
      - name: nginx
        image: nginx:1.25-alpine
        ports:
        - containerPort: 80
          name: http
          protocol: TCP
        volumeMounts:
        - name: html
          mountPath: /usr/share/nginx/html
        - name: nginx-config
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
        livenessProbe:
          httpGet:
            path: /healthz
            port: 80
          initialDelaySeconds: 10
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /healthz
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 5
        resources:
          requests:
            memory: "64Mi"
            cpu: "100m"
          limits:
            memory: "128Mi"
            cpu: "200m"
        securityContext:
          allowPrivilegeEscalation: false
          runAsNonRoot: false  # nginx needs to create cache directories
          runAsUser: 0
          capabilities:
            drop:
            - ALL
            add:
            - CHOWN
            - SETUID
            - SETGID
      volumes:
      - name: html
        configMap:
          name: nephoran-frontend-html
      - name: nginx-config
        configMap:
          name: nginx-config
      securityContext:
        fsGroup: 0
        runAsNonRoot: false  # nginx needs root for cache
        seccompProfile:
          type: RuntimeDefault

---
# Frontend Service
apiVersion: v1
kind: Service
metadata:
  name: nephoran-frontend
  namespace: nephoran-intent
  labels:
    app.kubernetes.io/name: nephoran-frontend
    app.kubernetes.io/component: ui
spec:
  type: ClusterIP
  ports:
  - port: 80
    targetPort: 80
    protocol: TCP
    name: http
  selector:
    app: nephoran-frontend

---
# Intent Ingest Backend Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: intent-ingest
  namespace: nephoran-intent
  labels:
    app.kubernetes.io/name: intent-ingest
    app.kubernetes.io/component: backend
    app.kubernetes.io/version: "1.0.0"
spec:
  replicas: 3
  selector:
    matchLabels:
      app: intent-ingest
  template:
    metadata:
      labels:
        app: intent-ingest
        app.kubernetes.io/name: intent-ingest
        app.kubernetes.io/component: backend
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/metrics"
    spec:
      containers:
      - name: intent-ingest
        image: nephoran/intent-ingest:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8080
          name: http
          protocol: TCP
        env:
        - name: MODE
          value: "llm"
        - name: PROVIDER
          value: "mock"  # TODO: Implement ollama provider
        - name: OLLAMA_ENDPOINT
          value: "http://ollama-service.ollama.svc.cluster.local:11434"
        - name: RAG_ENDPOINT
          value: "http://rag-service.rag-service.svc.cluster.local:8000"
        - name: HANDOFF_DIR
          value: "/var/nephoran/handoff"
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8080
          initialDelaySeconds: 15
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /healthz
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        volumeMounts:
        - name: handoff
          mountPath: /var/nephoran/handoff
        - name: schema
          mountPath: /app/docs/contracts
        securityContext:
          allowPrivilegeEscalation: false
          runAsNonRoot: true
          runAsUser: 1000
          capabilities:
            drop:
            - ALL
      volumes:
      - name: handoff
        emptyDir: {}
      - name: schema
        configMap:
          name: intent-schema
      securityContext:
        fsGroup: 1000
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault

---
# Intent Ingest Service
apiVersion: v1
kind: Service
metadata:
  name: intent-ingest-service
  namespace: nephoran-intent
  labels:
    app.kubernetes.io/name: intent-ingest
    app.kubernetes.io/component: backend
spec:
  type: ClusterIP
  ports:
  - port: 8080
    targetPort: 8080
    protocol: TCP
    name: http
  selector:
    app: intent-ingest

---
# Ingress for External Access (Optional)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: nephoran-ingress
  namespace: nephoran-intent
  labels:
    app.kubernetes.io/name: nephoran-intent
    app.kubernetes.io/component: ingress
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
spec:
  ingressClassName: nginx
  rules:
  - host: nephoran.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: nephoran-frontend
            port:
              number: 80
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: intent-ingest-service
            port:
              number: 8080

---
# NetworkPolicy for Frontend
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: nephoran-frontend-netpol
  namespace: nephoran-intent
spec:
  podSelector:
    matchLabels:
      app: nephoran-frontend
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 80
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: intent-ingest
    ports:
    - protocol: TCP
      port: 8080

---
# NetworkPolicy for Backend
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: intent-ingest-netpol
  namespace: nephoran-intent
spec:
  podSelector:
    matchLabels:
      app: intent-ingest
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: nephoran-frontend
    ports:
    - protocol: TCP
      port: 8080
  egress:
  # Allow egress to Ollama service
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: ollama
    ports:
    - protocol: TCP
      port: 11434
  # Allow egress to RAG service
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: rag-service
    ports:
    - protocol: TCP
      port: 8000
  # Allow DNS resolution
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
