apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: weaviate-deployment
  annotations:
    config.kubernetes.io/local-config: "true"
    kubernetes.io/description: "Production-ready Weaviate deployment for Nephoran Intent Operator"

# Common labels applied to all resources
commonLabels:
  app: weaviate
  component: vectordb
  part-of: nephoran-rag
  version: "1.28.1"
  tier: database

# Common annotations
commonAnnotations:
  kubernetes.io/managed-by: "kustomize"
  app.kubernetes.io/name: "weaviate"
  app.kubernetes.io/instance: "weaviate-nephoran"
  app.kubernetes.io/version: "1.28.1"
  app.kubernetes.io/component: "vector-database"
  app.kubernetes.io/part-of: "nephoran-intent-operator"

# Resources to deploy
resources:
# Core Weaviate deployment with all necessary components
- weaviate-deployment.yaml
# Security and access control
- rbac.yaml
- network-policy.yaml
# Monitoring and observability
- monitoring.yaml
# Backup and disaster recovery
- backup-cronjob.yaml
# Integration configuration for seamless operation
- integration-config.yaml

# Configuration generators for environment-specific settings
configMapGenerator:
- name: weaviate-environment-config
  literals:
  - ENVIRONMENT=production
  - LOG_LEVEL=info
  - METRICS_ENABLED=true
  - BACKUP_ENABLED=true
  - CLUSTER_ENABLED=true
  - TELEMETRY_DISABLED=false
- name: weaviate-performance-config
  literals:
  - QUERY_DEFAULTS_LIMIT=50
  - QUERY_MAXIMUM_RESULTS=10000
  - DEFAULT_VECTORIZER_MODULE=text2vec-openai
  - ENABLE_MODULES=text2vec-openai,generative-openai,qna-openai,sum-transformers,ref2vec-centroid
  - PERSISTENCE_DATA_PATH=/var/lib/weaviate
  - TRACK_VECTOR_DIMENSIONS=true
  - INDEXING_CLEANUP_INTERVAL_SECONDS=300
  - VECTOR_CACHE_MAX_OBJECTS=1000000
  - BACKUP_FILESYSTEM_PATH=/var/lib/weaviate/backups

# Secret generators (use external secret management in production)
secretGenerator:
- name: weaviate-deployment-secrets
  literals:
  - placeholder=replace-with-external-secrets
  type: Opaque

# Namespace for all resources
namespace: nephoran-system

# Images to use with specific versions
images:
- name: semitechnologies/weaviate
  newTag: "1.28.1"
- name: curlimages/curl
  newTag: "8.5.0"
- name: python
  newTag: "3.11-slim"

# Strategic merge patches for environment configuration
patchesStrategicMerge:
- |-
  apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: weaviate
    namespace: nephoran-system
  spec:
    template:
      spec:
        containers:
        - name: weaviate
          envFrom:
          - configMapRef:
              name: weaviate-environment-config
          - configMapRef:
              name: weaviate-performance-config

# JSON patches for fine-grained modifications
patchesJson6902:
- target:
    group: apps
    version: v1
    kind: Deployment
    name: weaviate
  patch: |-
    - op: add
      path: /spec/template/metadata/annotations/prometheus.io~1scrape
      value: "true"
    - op: add
      path: /spec/template/metadata/annotations/prometheus.io~1port
      value: "2112"
    - op: add
      path: /spec/template/metadata/annotations/prometheus.io~1path
      value: "/metrics"
- target:
    group: v1
    kind: Service
    name: weaviate
  patch: |-
    - op: add
      path: /metadata/annotations
      value:
        service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
        prometheus.io/scrape: "true"
        prometheus.io/port: "2112"

# Replica count (can be overridden per environment)
replicas:
- name: weaviate
  count: 3

# Transformers for environment-specific modifications
transformers:
- name: environment-transformer
  env:
    ENVIRONMENT: production

# Generators for additional resources
generators:
- name: backup-schedule-generator
  options:
    cron: "0 2 * * *"
    retention: "30d"

# Validation rules
validation:
  openapi:
    enabled: true
  kubeconform:
    enabled: true
    strict: true