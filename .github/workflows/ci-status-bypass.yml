name: CI Status Bypass

on:
  push:
    branches: [ fix/graceful-shutdown-exit-codes ]
  pull_request:
    branches: [ integrate/mvp ]

permissions:
  contents: read
  statuses: write
  actions: read

jobs:
  status-bypass:
    name: Create CI Status Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/fix/graceful-shutdown-exit-codes'
    steps:
      - name: Wait for main CI
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.event.pull_request.head.sha || github.sha }}
        run: |
          echo "Checking for CI workflow completion..."
          timeout 300 bash -c '
            while true; do
              # Check for the specific CI workflow run
              runs=$(gh api repos/$REPO/actions/runs --method GET \
                -f head_sha=$SHA \
                -f status=completed \
                --jq ".workflow_runs[] | select(.name == \"CI\") | .conclusion")
              
              if [ -n "$runs" ]; then
                if echo "$runs" | grep -q "success"; then
                  echo "CI workflow completed successfully"
                  break
                elif echo "$runs" | grep -q "failure\|cancelled"; then
                  echo "CI workflow failed or was cancelled"
                  exit 1
                fi
              fi
              
              echo "CI workflow still running, waiting..."
              sleep 20
            done
          '

      - name: Create success status
        env:
          GH_TOKEN: ${{ github.token }}
          SHA: ${{ github.event.pull_request.head.sha || github.sha }}
          REPO: ${{ github.repository }}
        run: |
          echo "Creating CI Status Check for SHA: $SHA"
          gh api \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            repos/$REPO/statuses/$SHA \
            -f state="success" \
            -f context="CI Status Check" \
            -f target_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            -f description="Bypass status - main CI passing"