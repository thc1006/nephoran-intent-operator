# =============================================================================
# Simplified CI Pipeline for PR #87 - Focus on Basic Requirements
# =============================================================================
# This workflow provides essential CI checks for the Nephoran Intent Operator
# Optimized for Go 1.24.6 with proper tool installation and error handling
# =============================================================================

name: PR CI

on:
  pull_request:
    branches: [ main, integrate/mvp ]
  workflow_dispatch: {}

concurrency:
  group: pr-ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read

env:
  GO_VERSION: "1.24.6"
  CONTROLLER_GEN_VERSION: "v0.19.0"
  GOLANGCI_LINT_VERSION: "v1.64.3"
  CGO_ENABLED: "0"
  GOPROXY: "https://proxy.golang.org,direct"
  GOSUMDB: "sum.golang.org"
  GOPRIVATE: "github.com/thc1006/*"

jobs:
  # =============================================================================
  # Essential CI Checks
  # =============================================================================
  essential-checks:
    name: Essential CI Checks
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup GitHub authentication for Go modules
        run: git config --global url."https://${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Go 1.24.6
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true
          cache: true
          cache-dependency-path: |
            go.sum
            **/go.sum

      - name: Cache Go dependencies and tools
        uses: actions/cache@v4
        with:
          path: |
            ~/go/bin
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-deps-${{ env.GO_VERSION }}-${{ env.CONTROLLER_GEN_VERSION }}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-deps-${{ env.GO_VERSION }}-${{ env.CONTROLLER_GEN_VERSION }}-
            ${{ runner.os }}-go-deps-${{ env.GO_VERSION }}-

      - name: Go dependency integrity check
        run: |
          echo "Verifying go.sum integrity..."
          set -euo pipefail
          
          # Verify go.sum integrity
          if [ -f go.sum ]; then
            echo "go.sum found, verifying integrity..."
            if ! go mod verify; then
              echo "❌ go.sum integrity check failed"
              echo "Attempting to fix with go mod tidy..."
              go mod tidy
              if ! go mod verify; then
                echo "❌ Unable to fix go.sum integrity issues"
                exit 1
              fi
              echo "✅ go.sum integrity fixed with go mod tidy"
            else
              echo "✅ go.sum integrity verified"
            fi
          else
            echo "⚠️ go.sum not found, running go mod download to generate"
            go mod download
          fi

      - name: Go mod tidy check
        run: |
          echo "Running go mod tidy to ensure clean dependencies..."
          set -euo pipefail
          
          # Run go mod tidy
          go mod tidy
          
          # Check if go.mod or go.sum changed
          if ! git diff --exit-code go.mod go.sum; then
            echo "❌ go.mod or go.sum is not up to date"
            echo "Files that changed after go mod tidy:"
            git diff --name-only go.mod go.sum || true
            echo ""
            echo "Please run 'go mod tidy' locally and commit the changes"
            echo "Diff:"
            git diff go.mod go.sum
            exit 1
          fi
          echo "✅ go.mod and go.sum are up to date"

      - name: Download and cache dependencies
        run: |
          echo "Downloading Go modules with enhanced caching..."
          set -euo pipefail
          
          # Download all dependencies
          go mod download -x
          
          # Verify all downloaded modules
          go mod verify
          
          # Pre-compile standard library for faster builds
          go install -a std
          
          echo "✅ Dependencies downloaded and cached successfully"

      - name: Install controller-gen
        run: |
          echo "Installing controller-gen v${{ env.CONTROLLER_GEN_VERSION }}..."
          set -euo pipefail
          
          # Create bin directory
          mkdir -p bin
          
          # Install controller-gen directly to bin/
          GOBIN="$(pwd)/bin" go install sigs.k8s.io/controller-tools/cmd/controller-gen@${{ env.CONTROLLER_GEN_VERSION }}
          
          # Verify installation
          if [ -f "bin/controller-gen" ]; then
            echo "✅ controller-gen installed successfully"
            ./bin/controller-gen --version
          else
            echo "❌ controller-gen installation failed"
            ls -la bin/ || true
            exit 1
          fi

      - name: Code generation and verification
        run: |
          echo "Generating code and manifests..."
          set -euo pipefail
          
          # Use the installed controller-gen directly for reliable operation
          echo "Running code generation..."
          ./bin/controller-gen object:headerFile="hack/boilerplate.go.txt" paths="./..."
          
          echo "Running manifest generation..."
          ./bin/controller-gen rbac:roleName=manager-role crd webhook paths="./..." output:crd:artifacts:config=config/crd/bases
          
          # Check for changes
          echo "Checking for uncommitted changes..."
          if ! git diff --exit-code; then
            echo "❌ Generated files are not up to date"
            echo "Files that changed:"
            git diff --name-only
            echo ""
            echo "Please run 'make generate manifests' locally and commit the changes"
            exit 1
          fi
          echo "✅ Generated files are up to date"

      - name: Format check
        run: |
          echo "Checking code formatting..."
          set -euo pipefail
          
          # Run go fmt
          if ! go fmt ./...; then
            echo "❌ Code formatting issues found"
            exit 1
          fi
          
          # Check for changes after formatting
          if ! git diff --exit-code; then
            echo "❌ Code is not properly formatted"
            echo "Please run 'go fmt ./...' locally"
            exit 1
          fi
          echo "✅ Code is properly formatted"

      - name: Vet check
        run: |
          echo "Running go vet..."
          if ! go vet ./...; then
            echo "❌ Go vet found issues"
            exit 1
          fi
          echo "✅ Go vet passed"

      - name: Build check
        run: |
          echo "Building all packages..."
          if ! go build ./...; then
            echo "❌ Build failed"
            exit 1
          fi
          echo "✅ Build succeeded"

      - name: Test check
        run: |
          echo "Running tests..."
          set -euo pipefail
          
          # Create test report directory
          mkdir -p test-results
          
          # Run tests with timeout, race detection, and skip vet
          if ! go test -v -race -vet=off -timeout=10m ./... 2>&1 | tee test-results/test-output.txt; then
            echo "❌ Tests failed"
            echo "Test output saved to test-results/test-output.txt"
            exit 1
          fi
          echo "✅ All tests passed"

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results/
          retention-days: 3

  # =============================================================================
  # Quick Lint Check
  # =============================================================================
  lint-check:
    name: Quick Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup GitHub authentication for Go modules
        run: git config --global url."https://${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Go 1.24.6  
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true
          cache: true
          cache-dependency-path: |
            go.sum
            **/go.sum

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: ${{ env.GOLANGCI_LINT_VERSION }}
          args: --timeout=8m --config=.golangci-fast.yml

  # =============================================================================
  # Status Check
  # =============================================================================
  status-check:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [essential-checks, lint-check]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "=== PR CI Results ==="
          echo "Essential checks: ${{ needs.essential-checks.result }}"
          echo "Lint check: ${{ needs.lint-check.result }}"
          
          if [[ "${{ needs.essential-checks.result }}" == "failure" ]]; then
            echo "❌ Essential checks failed"
            exit 1
          fi
          
          if [[ "${{ needs.lint-check.result }}" == "failure" ]]; then
            echo "⚠️ Lint checks failed (non-blocking for now)"
          fi
          
          echo "✅ PR CI completed successfully"