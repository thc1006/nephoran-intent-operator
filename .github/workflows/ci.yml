name: CI

on:
  workflow_dispatch: {}
  push:
    branches: [ main, integrate/mvp, "feat/**", "chore/**" ]
  pull_request:
    branches: [ main, integrate/mvp ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: nephoran-intent-operator

jobs:
  # =============================================================================
  # Repository Hygiene Check Job
  # =============================================================================
  hygiene:
    name: Repository Hygiene
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Check for large files not in LFS
        id: large-files
        shell: bash
        run: |
          set -euo pipefail
          echo "## ðŸ§¹ Repository Hygiene Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Find files larger than 10MB not tracked by LFS
          large_files=""
          file_count=0
          
          echo "| File | Size | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|--------|" >> $GITHUB_STEP_SUMMARY
          
          # Check if git-lfs is available
          if command -v git-lfs >/dev/null 2>&1; then
            # Get LFS tracked files
            lfs_files=$(git lfs ls-files --name-only 2>/dev/null || true)
          else
            lfs_files=""
          fi
          
          # Find files larger than 10MB
          while IFS= read -r -d '' file; do
            size=$(stat --format="%s" "$file" 2>/dev/null || echo "0")
            if [ "$size" -gt 10485760 ]; then  # 10MB in bytes
              file_count=$((file_count + 1))
              size_mb=$(echo "scale=2; $size / 1048576" | bc)
              
              # Check if file is tracked by LFS
              if echo "$lfs_files" | grep -q "^${file}$" 2>/dev/null; then
                echo "| $file | ${size_mb}MB | âœ… In LFS |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| $file | ${size_mb}MB | âš ï¸ Not in LFS |" >> $GITHUB_STEP_SUMMARY
                large_files="$large_files $file"
              fi
            fi
          done < <(find . -type f -not -path './.git/*' -not -path './vendor/*' -print0)
          
          if [ "$file_count" -eq 0 ]; then
            echo "| No large files found | - | âœ… Clean |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Files checked:** $(find . -type f -not -path './.git/*' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "**Large files found:** $file_count" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "$large_files" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âš ï¸ Action Required" >> $GITHUB_STEP_SUMMARY
            echo "The following large files should be tracked with Git LFS:" >> $GITHUB_STEP_SUMMARY
            for file in $large_files; do
              echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To fix:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "git lfs track \"*.extension\"  # Add appropriate patterns" >> $GITHUB_STEP_SUMMARY
            echo "git add .gitattributes" >> $GITHUB_STEP_SUMMARY
            echo "git add . && git commit -m \"Track large files with LFS\"" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            echo "large_files_found=true" >> $GITHUB_OUTPUT
          else
            echo "large_files_found=false" >> $GITHUB_OUTPUT
          fi

  # =============================================================================
  # Change Detection Job - Conditional Job Execution
  # =============================================================================
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    timeout-minutes: 3
    outputs:
      api: ${{ steps.changes.outputs.api }}
      controllers: ${{ steps.changes.outputs.controllers }}
      frontend: ${{ steps.changes.outputs.frontend }}
      docs: ${{ steps.changes.outputs.docs }}
      docker: ${{ steps.changes.outputs.docker }}
      charts: ${{ steps.changes.outputs.charts }}
      tools: ${{ steps.changes.outputs.tools }}
      workflows: ${{ steps.changes.outputs.workflows }}
      go-code: ${{ steps.changes.outputs.go-code }}
      python-code: ${{ steps.changes.outputs.python-code }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            api:
              - 'api/**'
              - 'pkg/api/**'
            controllers:
              - 'controllers/**'
              - 'pkg/controllers/**'
              - 'cmd/**'
            frontend:
              - 'web/**'
              - 'ui/**'
              - 'frontend/**'
              - 'pkg/ui/**'
            docs:
              - 'docs/**'
              - '*.md'
              - '.github/**'
              - 'examples/**'
            docker:
              - 'Dockerfile*'
              - 'docker/**'
              - '.dockerignore'
            charts:
              - 'charts/**'
              - 'helm/**'
              - 'deployments/**'
            tools:
              - 'tools/**'
              - 'scripts/**'
            workflows:
              - '.github/workflows/**'
            go-code:
              - '**/*.go'
              - 'go.mod'
              - 'go.sum'
              - 'Makefile'
            python-code:
              - '**/*.py'
              - 'requirements*.txt'
              - 'pyproject.toml'
              - 'setup.py'

      - name: Log detected changes
        run: |
          echo "## ðŸ” Change Detection Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Changed | Files |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| API | ${{ steps.changes.outputs.api }} | $(echo '${{ steps.changes.outputs.api_files }}' | wc -w) |" >> $GITHUB_STEP_SUMMARY
          echo "| Controllers | ${{ steps.changes.outputs.controllers }} | $(echo '${{ steps.changes.outputs.controllers_files }}' | wc -w) |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ steps.changes.outputs.frontend }} | $(echo '${{ steps.changes.outputs.frontend_files }}' | wc -w) |" >> $GITHUB_STEP_SUMMARY
          echo "| Docs | ${{ steps.changes.outputs.docs }} | $(echo '${{ steps.changes.outputs.docs_files }}' | wc -w) |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker | ${{ steps.changes.outputs.docker }} | $(echo '${{ steps.changes.outputs.docker_files }}' | wc -w) |" >> $GITHUB_STEP_SUMMARY
          echo "| Charts | ${{ steps.changes.outputs.charts }} | $(echo '${{ steps.changes.outputs.charts_files }}' | wc -w) |" >> $GITHUB_STEP_SUMMARY
          echo "| Tools | ${{ steps.changes.outputs.tools }} | $(echo '${{ steps.changes.outputs.tools_files }}' | wc -w) |" >> $GITHUB_STEP_SUMMARY
          echo "| Workflows | ${{ steps.changes.outputs.workflows }} | $(echo '${{ steps.changes.outputs.workflows_files }}' | wc -w) |" >> $GITHUB_STEP_SUMMARY
          echo "| Go Code | ${{ steps.changes.outputs.go-code }} | $(echo '${{ steps.changes.outputs.go-code_files }}' | wc -w) |" >> $GITHUB_STEP_SUMMARY
          echo "| Python Code | ${{ steps.changes.outputs.python-code }} | $(echo '${{ steps.changes.outputs.python-code_files }}' | wc -w) |" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # CRD Generation Job - Independent job for generating CRDs
  # =============================================================================
  crds:
    name: Generate CRDs
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.api == 'true' || needs.changes.outputs.go-code == 'true'
    timeout-minutes: 10
    outputs:
      crd-status: ${{ steps.generate.outputs.status }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Cache controller tools
        uses: actions/cache@v4
        with:
          path: ~/go/bin/controller-gen
          key: ${{ runner.os }}-controller-gen-${{ hashFiles('go.sum') }}
          restore-keys: |
            ${{ runner.os }}-controller-gen-

      - name: Install controller-gen
        run: |
          if [ ! -f ~/go/bin/controller-gen ]; then
            go install sigs.k8s.io/controller-tools/cmd/controller-gen@latest
          fi

      - name: Generate CRDs
        id: generate
        run: |
          mkdir -p deployments/crds
          
          echo "=== Generating CRDs ==="
          ~/go/bin/controller-gen crd:crdVersions=v1 rbac:roleName=manager-role webhook paths="./api/..." output:crd:artifacts:config=deployments/crds/
          
          # Check if any CRDs were generated
          crd_count=$(find deployments/crds -name '*.yaml' | wc -l)
          
          echo "## ðŸ—ï¸ CRD Generation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**CRDs generated:** $crd_count" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$crd_count" -gt 0 ]; then
            echo "### Generated CRDs:" >> $GITHUB_STEP_SUMMARY
            for crd in deployments/crds/*.yaml; do
              echo "- $(basename "$crd")" >> $GITHUB_STEP_SUMMARY
            done
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "**Warning:** No CRDs generated" >> $GITHUB_STEP_SUMMARY
            echo "status=empty" >> $GITHUB_OUTPUT
          fi

      - name: Upload CRD artifacts
        uses: actions/upload-artifact@v4
        with:
          name: generated-crds
          path: deployments/crds/
          if-no-files-found: ignore
          retention-days: 1

  # =============================================================================
  # Unit Tests Job - Fast execution tests only
  # =============================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.go-code == 'true'
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Cache test dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
            ~/go/bin
          key: ${{ runner.os }}-test-cache-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-test-cache-

      - name: Run unit tests with coverage
        run: |
          echo "=== Running Unit Tests with Coverage ==="
          mkdir -p .test-reports
          
          # Run tests with coverage
          go test -v -race -coverprofile=.test-reports/coverage.out -covermode=atomic ./... | tee .test-reports/test.log
          
          # Generate coverage HTML report
          go tool cover -html=.test-reports/coverage.out -o .test-reports/coverage.html
          
          # Calculate coverage percentage
          coverage_percent=$(go tool cover -func=.test-reports/coverage.out | grep total | awk '{print $3}')
          
          echo "## ðŸ§ª Unit Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Coverage:** $coverage_percent" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Show test summary
          test_count=$(grep -c "^=== RUN" .test-reports/test.log || echo "0")
          pass_count=$(grep -c "^--- PASS" .test-reports/test.log || echo "0")
          fail_count=$(grep -c "^--- FAIL" .test-reports/test.log || echo "0")
          
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tests Run | $test_count |" >> $GITHUB_STEP_SUMMARY
          echo "| Passed | $pass_count |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed | $fail_count |" >> $GITHUB_STEP_SUMMARY

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: .test-reports/
          retention-days: 7

  # =============================================================================
  # Lint Job - Code quality and style checks
  # =============================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.go-code == 'true'
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: v1.61.0
          args: --timeout=5m --issues-exit-code=0 --out-format=colored-line-number

      - name: Run additional linters
        run: |
          echo "=== Additional Code Quality Checks ==="
          
          # Install additional tools
          go install honnef.co/go/tools/cmd/staticcheck@latest
          go install github.com/fzipp/gocyclo/cmd/gocyclo@latest
          
          # Run staticcheck
          echo "Running staticcheck..."
          staticcheck ./... || echo "Staticcheck completed with warnings"
          
          # Check cyclomatic complexity
          echo "Checking cyclomatic complexity..."
          gocyclo -over 15 . || echo "High complexity functions found"

      - name: Lint summary
        run: |
          echo "## ðŸ” Lint Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Linting completed. Check the Actions logs for detailed results." >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Security Scan Job - Enhanced vulnerability checking with resilient handling
  # =============================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [changes, crds]
    if: always() && needs.changes.outputs.go-code == 'true'
    timeout-minutes: 20
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Cache Go modules and security databases
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Cache govulncheck database
        uses: actions/cache@v4
        with:
          path: ~/.cache/go-security-db
          key: ${{ runner.os }}-govulncheck-db-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-govulncheck-db-

      - name: Download and verify dependencies (resilient)
        shell: bash
        continue-on-error: true
        run: |
          echo "=== Attempting to download and verify dependencies ==="
          
          # Set Go proxy environment with fallback options
          export GOPROXY="https://proxy.golang.org,direct"
          export GOSUMDB="sum.golang.org"
          export GOTIMEOUT="120s"
          
          # Attempt go mod download with timeout
          timeout 180s go mod download || {
            echo "âš ï¸ go mod download timed out or failed - continuing with cached modules"
          }
          
          # Attempt go mod verify
          timeout 60s go mod verify || {
            echo "âš ï¸ go mod verify failed - this may be due to network issues or cache state"
            echo "Attempting to continue with available modules..."
          }
          
          # Check if we have sufficient modules to proceed
          module_count=$(find ~/go/pkg/mod -name "go.mod" 2>/dev/null | wc -l || echo "0")
          echo "Found $module_count cached modules"
          
          if [ "$module_count" -gt 10 ]; then
            echo "âœ… Sufficient cached modules available to proceed"
          else
            echo "âš ï¸ Limited cached modules - some tools may not work properly"
          fi

      - name: Download CRD artifacts
        uses: actions/download-artifact@v4
        with:
          name: generated-crds
          path: deployments/crds/
        continue-on-error: true

      - name: Install security tools (resilient)
        continue-on-error: true
        run: |
          echo "=== Installing security scanning tools ==="
          
          # Try to install govulncheck with timeout
          timeout 120s go install golang.org/x/vuln/cmd/govulncheck@v1.1.4 || {
            echo "âš ï¸ govulncheck installation failed or timed out"
            echo "Checking if govulncheck is already available..."
            if command -v govulncheck >/dev/null 2>&1; then
              echo "âœ… govulncheck is available from cache/previous install"
            else
              echo "âŒ govulncheck not available - security scan may be limited"
            fi
          }

      - name: Run govulncheck (non-blocking)
        shell: bash
        continue-on-error: true
        env:
          GOVULNCHECK_DB: ~/.cache/go-security-db
        run: |
          echo "=== Running vulnerability scan ==="
          mkdir -p .excellence-reports
          
          if command -v govulncheck >/dev/null 2>&1; then
            echo "Running govulncheck with timeout..."
            
            # Run with timeout and capture both success and failure cases
            timeout 300s govulncheck -json ./... > .excellence-reports/govulncheck.json 2>&1 && {
              echo "âœ… Vulnerability scan completed successfully"
              
              # Check if any vulnerabilities were found
              if [ -s .excellence-reports/govulncheck.json ]; then
                vuln_count=$(grep -c '"message".*"vulnerability"' .excellence-reports/govulncheck.json 2>/dev/null || echo "0")
                echo "Found $vuln_count potential vulnerabilities"
                
                if [ "$vuln_count" -gt 0 ]; then
                  echo "âš ï¸ Vulnerabilities detected - check the report for details"
                else
                  echo "âœ… No vulnerabilities detected"
                fi
              fi
            } || {
              echo "âš ï¸ Vulnerability scan completed with warnings or timed out"
              
              # Even if the scan failed, try to generate a basic report
              echo '{"message": "Security scan completed with issues", "timestamp": "'$(date -Iseconds)'", "status": "partial"}' > .excellence-reports/govulncheck.json
            }
          else
            echo "âŒ govulncheck not available - creating placeholder report"
            echo '{"message": "govulncheck not available", "timestamp": "'$(date -Iseconds)'", "status": "unavailable"}' > .excellence-reports/govulncheck.json
          fi
          
          echo "Report saved at .excellence-reports/govulncheck.json"
          ls -la .excellence-reports/ || echo "Reports directory not accessible"

      - name: Generate security summary
        if: always()
        run: |
          echo "## ðŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f .excellence-reports/govulncheck.json ]; then
            echo "âœ… Security scan report generated" >> $GITHUB_STEP_SUMMARY
            
            # Try to extract basic info from the report
            if grep -q "vulnerability" .excellence-reports/govulncheck.json 2>/dev/null; then
              echo "âš ï¸ **Vulnerabilities detected** - review the detailed report" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… No critical vulnerabilities detected" >> $GITHUB_STEP_SUMMARY
            fi
            
            file_size=$(stat -c%s .excellence-reports/govulncheck.json 2>/dev/null || echo "unknown")
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Report size:** $file_size bytes" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Security scan report not generated" >> $GITHUB_STEP_SUMMARY
            echo "This may be due to network connectivity issues or tool installation problems." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the security scan artifacts" >> $GITHUB_STEP_SUMMARY
          echo "2. Address any reported vulnerabilities" >> $GITHUB_STEP_SUMMARY
          echo "3. Ensure network connectivity for future scans" >> $GITHUB_STEP_SUMMARY

      - name: Upload security scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: .excellence-reports/
          if-no-files-found: ignore
          retention-days: 7

  # =============================================================================
  # Tools Test Job - Test the tools directory when changed
  # =============================================================================
  tools-test:
    name: Tools Test
    runs-on: ubuntu-latest
    needs: [hygiene, changes]
    if: needs.changes.outputs.tools == 'true'
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Test tools
        run: |
          echo "=== Testing Tools ==="
          
          # Test Go tools
          for tool_dir in tools/*/; do
            if [ -f "$tool_dir/main.go" ] || [ -f "$tool_dir/go.mod" ]; then
              echo "Testing $tool_dir"
              (cd "$tool_dir" && go test ./... -v)
            fi
          done
          
          # Test scripts that have accompanying tests
          for script in scripts/*.sh; do
            test_script="${script%.sh}_test.sh"
            if [ -f "$test_script" ]; then
              echo "Testing $script"
              bash "$test_script"
            fi
          done

      - name: Tools test summary
        run: |
          echo "## ðŸ”§ Tools Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Tools testing completed successfully." >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Docker Build Job - Multi-arch container builds
  # =============================================================================
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [changes, unit-tests, lint]
    if: needs.changes.outputs.docker == 'true' || needs.changes.outputs.go-code == 'true'
    timeout-minutes: 20
    strategy:
      matrix:
        service: [conductor-loop, intent-ingest, nephio-bridge]
        include:
          - service: conductor-loop
            dockerfile: Dockerfile
            context: .
            service_type: go
          - service: intent-ingest
            dockerfile: Dockerfile
            context: .
            service_type: go
          - service: nephio-bridge
            dockerfile: Dockerfile
            context: .
            service_type: go
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ matrix.service }}-${{ hashFiles('Dockerfile', 'go.sum') }}
          restore-keys: |
            ${{ runner.os }}-buildx-${{ matrix.service }}-

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: false
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.service }}:ci
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          build-args: |
            SERVICE=${{ matrix.service }}
            SERVICE_TYPE=${{ matrix.service_type }}

      # Move cache to prevent unlimited growth
      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Docker build summary
        run: |
          echo "## ðŸ³ Docker Build - ${{ matrix.service }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Image built successfully: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.service }}:ci" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Build Validation - Final cross-checks
  # =============================================================================
  build-validation:
    name: Build Validation
    runs-on: ubuntu-latest
    needs: [unit-tests, lint, security, docker-build]
    if: always()
    timeout-minutes: 10
    steps:
      - name: Check job statuses
        run: |
          echo "## ðŸ“Š CI Build Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status | Required |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result || 'skipped' }} | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result || 'skipped' }} | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result || 'skipped' }} | âš ï¸ (advisory) |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | ${{ needs.docker-build.result || 'skipped' }} | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Determine overall status
          unit_tests="${{ needs.unit-tests.result }}"
          lint="${{ needs.lint.result }}"
          docker="${{ needs.docker-build.result }}"
          security="${{ needs.security.result }}"
          
          # Critical jobs that must pass
          critical_failure=false
          if [ "$unit_tests" = "failure" ] || [ "$lint" = "failure" ] || [ "$docker" = "failure" ]; then
            critical_failure=true
          fi
          
          if [ "$critical_failure" = "true" ]; then
            echo "âŒ **Build Failed** - Critical jobs failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Required Actions:" >> $GITHUB_STEP_SUMMARY
            [ "$unit_tests" = "failure" ] && echo "- Fix failing unit tests" >> $GITHUB_STEP_SUMMARY
            [ "$lint" = "failure" ] && echo "- Address linting issues" >> $GITHUB_STEP_SUMMARY
            [ "$docker" = "failure" ] && echo "- Fix Docker build problems" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… **Build Passed** - All critical checks succeeded" >> $GITHUB_STEP_SUMMARY
            
            if [ "$security" = "failure" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âš ï¸ **Security scan had issues** - Please review security results when network connectivity improves" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Metrics:" >> $GITHUB_STEP_SUMMARY
          echo "- **Duration:** ${{ github.event.head_commit.timestamp && github.run_started_at }} minutes" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Success Job - Final gate for required checks
  # =============================================================================
  success:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [build-validation]
    if: always()
    steps:
      - name: Check overall success
        run: |
          if [ "${{ needs.build-validation.result }}" = "success" ]; then
            echo "ðŸŽ‰ All required checks passed!"
            echo "ready_for_merge=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Some required checks failed"
            echo "ready_for_merge=false" >> $GITHUB_OUTPUT
            exit 1
          fi